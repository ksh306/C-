#include <stdio.h>
#include <string.h>
#define y 20
#define m 5

typedef struct{
    int id;
    char name[y];
    int price;
    int stock;
    int sold;
    int totalsales;
} Product;

void menu_stock(Product p[], int count);
void menu_sales(Product p[], int count);
void menu_indiv(Product p[], int count);
void menu_all(Product p[], int count);
void menu_save(Product p[], int count);
void menu_load(Product p[], int count);

int main(){
    Product p[m] = {0};
    int menu = 0;

    printf("[쇼핑몰 재고 관리 프로그램]\n");

    while(menu != 7){
        printf("\n> 메뉴를 선택하세요 (1. 입고, 2. 판매, 3. 개별상품정보, 4. 전체상품정보, 5. 저장, 6. 불러오기, 7. 종료)\n> ");
        scanf("%d", &menu);

        if(menu == 1){
            menu_stock(p, m);
        }
        else if(menu == 2){
            menu_sales(p, m);
        }
        else if(menu == 3){
            menu_indiv(p, m);
        }
        else if(menu == 4){
            menu_all(p, m);
        }
        else if(menu == 5){
            menu_save(p, m);
        }
        else if(menu == 6){
            menu_load(p, m);
        }
        else if(menu == 7){
            printf("프로그램 종료\n");
        }
        else{
            printf("잘못된 입력\n");
        }
    }
    return 0;
}

// 입고
void menu_stock(Product p[], int count){
    int id;
    printf("\n상품ID: ");
    scanf("%d", &id);

    if(id < 1 || id > count){
        printf("잘못된 상품 ID\n");
        return;
    }

    if(p[id - 1].id == 0){
        p[id - 1].id = id;
        getchar();
        printf("상품명: ");
        fgets(p[id - 1].name, y, stdin);
        p[id - 1].name[strcspn(p[id - 1].name, "\n")] = '\0';
        printf("입고량: ");
        scanf("%d", &p[id - 1].stock);
        printf("판매가격: ");
        scanf("%d", &p[id - 1].price);
    } else{
        int addstock;
        printf("입고량: ");
        scanf("%d", &addstock);
        p[id - 1].stock += addstock;
        printf("판매가격: ");
        scanf("%d", &p[id - 1].price);
    }
}

// 판매
void menu_sales(Product p[], int count){
    int id;
    printf("\n상품ID: ");
    scanf("%d", &id);

    if(id < 1 || id > count || p[id - 1].id == 0){
        printf("잘못된 상품\n");
        return;
    }

    int z;
    printf("판매수량: ");
    scanf("%d", &z);

    if(z >= p[id - 1].stock){
        p[id - 1].sold += p[id - 1].stock;
        p[id - 1].totalsales += p[id - 1].stock * p[id - 1].price;
        p[id - 1].stock = 0;
    } 
    else{
        p[id - 1].stock -= z;
        p[id - 1].sold += z;
        p[id - 1].totalsales += z * p[id - 1].price;
    }
}

// 개별상품정보
void menu_indiv(Product p[], int count){
    int id;
    printf("\n상품ID: ");
    scanf("%d", &id);

    if(id < 1 || id > count || p[id - 1].id == 0){
        printf("잘못된 상품\n");
        return;
    }

    Product *prod = &p[id - 1];
    printf("\n상품 ID : %d\n", prod->id);
    printf("상품명 : %s\n", prod->name);
    printf("가격 : %d\n", prod->price);
    printf("입고량 : %d\n", prod->stock);
    printf("판매량 : %d\n", prod->sold);
    printf("총 판매금액 : %d\n", prod->totalsales);
}

// 전체상품정보
void menu_all(Product p[], int count){
    int totalstock=0, totalsold=0;
    int maxID=-1, minID=-1;

    printf("재고수량 : ");
    for(int i=0; i<count; i++){
        printf("%d ", p[i].stock);
        totalstock+=(p[i].stock+p[i].sold);
        totalsold+=p[i].sold;

        if(p[i].id!=0){
            if(maxID==-1||p[i].sold>p[maxID].sold) maxID=i;
            if(minID==-1||p[i].sold<p[minID].sold) minID=i;
        }
    }
    printf("\n");

    float rate=(totalstock>0)?(float)totalsold/totalstock*100.0:0;
    printf("총 판매량 : %d (판매율 %.2f%%)\n", totalsold, rate);

    if(maxID!=-1)
        printf("가장 많이 판매된 상품 : ID %d, 상품명 : %s, 판매량 %d\n",
               p[maxID].id, p[maxID].name, p[maxID].sold);
    if(minID!=-1)
        printf("가장 적게 판매된 상품 : ID %d, 상품명 : %s, 판매량 %d\n",
               p[minID].id, p[minID].name, p[minID].sold);

    for(int i=0; i<count; i++){
        if(p[i].id!=0&&p[i].stock<3)
            printf("상품 ID %d : 상품명 : %s 재고부족(%d)\n", p[i].id, p[i].name, p[i].stock);
    }
}

// 상품정보 저장
void menu_save(Product p[], int count){
    FILE *fp = fopen("product.txt", "w");
    if(fp == NULL){
        printf("error\n");
        return;
    }

    for(int i=0; i<count; i++){
        if(p[i].id != 0){
            fprintf(fp, "%d %s %d %d %d %d\n",
                p[i].id, p[i].name, p[i].price, p[i].stock, p[i].sold, p[i].totalsales);
        }
    }

    fclose(fp);
}

// 상품정보 불러오기
void menu_load(Product p[], int count){
    FILE *fp = fopen("product.txt", "r");
    if(fp == NULL){
        printf("error\n");
        return;
    }

    for(int i=0; i<count; i++){
        p[i].id=0;
    }

    int i=0;
    while(i<count && fscanf(fp, "%d %s %d %d %d %d",
           &p[i].id, p[i].name, &p[i].price, &p[i].stock, &p[i].sold, &p[i].totalsales) != EOF){
        i++;
    }

    fclose(fp);
}
